// Prisma Schema for LaunchPro - Digital Ads Campaign Management (Multi-Account Support)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Platform {
  TONIC
  META
  TIKTOK
  TABOOLA
}

enum CampaignStatus {
  DRAFT              // Initial creation, not yet launched
  AWAITING_DESIGN    // Sent to DesignFlow, waiting for design team
  PENDING_ARTICLE    // Waiting for Tonic article approval (async)
  ARTICLE_APPROVED   // Article approved, ready to continue processing
  GENERATING_AI      // AI is generating content
  READY_TO_LAUNCH    // AI content ready, waiting for launch
  LAUNCHING          // In process of launching to platforms
  ACTIVE             // Successfully launched and active
  PAUSED             // Paused by user
  COMPLETED          // Campaign finished
  FAILED             // Failed during launch
}

enum MediaType {
  IMAGE
  VIDEO
}

enum CampaignType {
  CBO  // Campaign Budget Optimization
  ABO  // Ad Set Budget Optimization
}

enum AccountType {
  TONIC
  META
  TIKTOK
  TABOOLA
}

enum ManagerRole {
  SUPERADMIN
  MANAGER
}

enum StopLossType {
  IMMEDIATE_LOSS      // Net Revenue <= -$35
  TIME_BASED_LOSS     // 48+ hours ACTIVE AND Net Revenue <= -$10
}

// ============================================
// ACCOUNT MANAGEMENT
// ============================================

model Account {
  id          String      @id @default(cuid())
  name        String      // e.g., "TikTok TG-JM", "Meta B1 - Capital Quick"
  accountType AccountType

  // Tonic accounts
  tonicConsumerKey    String? // For Tonic accounts
  tonicConsumerSecret String? // For Tonic accounts
  tonicJwtToken       String? @db.Text // Cached JWT token
  tonicTokenExpiry    DateTime? // Token expiration

  // Tonic capabilities cache (to avoid repeated API calls)
  tonicSupportsRSOC   Boolean? // Does this account support RSOC campaigns?
  tonicSupportsDisplay Boolean? // Does this account support Display campaigns?
  tonicRSOCDomains    Json? // Available RSOC domains with languages
  tonicCapabilitiesLastChecked DateTime? // When were capabilities last checked

  // Meta accounts
  metaAdAccountId String? // e.g., "act_641975565566309"
  metaPortfolio   String? // e.g., "Capital Quick LLC"
  metaPageId      String? // e.g., "1039541308325786"
  metaAccessToken String? @db.Text // Account-specific access token
  metaPixelId     String? // Account-specific pixel ID
  metaInstagramAccountId String? // Instagram Account ID linked to this Meta account
  metaInstagramUsername  String? // Instagram username (e.g., "capitalhome")

  // TikTok accounts
  tiktokAdvertiserId String? // e.g., "7476563770333167633"
  tiktokAccessToken  String? @db.Text // Account-specific access token
  tiktokPixelId      String? // Account-specific pixel ID

  // Taboola accounts
  taboolaAccountId    String? // Account ID de Taboola (string alfanumÃ©rico como "taboola-account-name")
  taboolaAccessToken  String? @db.Text // Account-specific access token
  taboolaTokenExpiry  DateTime? // Token expiration (12 hours)
  taboolaPixelId      String? // Account-specific pixel ID

  // Linked Tonic Account (for Meta/TikTok/Taboola accounts)
  linkedTonicAccountId String?
  linkedTonicAccount   Account?  @relation("LinkedTonicAccount", fields: [linkedTonicAccountId], references: [id])
  linkedAccounts       Account[] @relation("LinkedTonicAccount")

  // Relationships
  campaignsAsTonic CampaignPlatform[] @relation("TonicAccount")
  campaignsAsMeta  CampaignPlatform[] @relation("MetaAccount")
  campaignsAsTikTok CampaignPlatform[] @relation("TikTokAccount")
  campaignsAsTaboola CampaignPlatform[] @relation("TaboolaAccount")

  // Ad Rules
  adRulesAsMeta    AdRule[]       @relation("MetaRuleAccount")
  adRulesAsTikTok  AdRule[]       @relation("TikTokRuleAccount")
  adRulesAsTonic   AdRule[]       @relation("TonicRuleAccount")

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountType, name])
  @@index([accountType])
  @@index([isActive])
  @@index([linkedTonicAccountId])
}

// ============================================
// MAIN MODELS
// ============================================

model Campaign {
  id                String             @id @default(cuid())
  name              String
  status            CampaignStatus     @default(DRAFT)
  campaignType      CampaignType

  // Owner - Manager who created this campaign
  createdById       String?
  createdBy         Manager?           @relation("CampaignCreator", fields: [createdById], references: [id])

  // Tonic Configuration
  offerId           String
  offer             Offer              @relation(fields: [offerId], references: [id])
  country           String
  language          String

  // AI Content
  copyMaster        String?
  communicationAngle String?
  keywords          String[]           @default([])
  contentGenerationPhrases String[]    @default([])  // RSOC content generation phrases

  // Platform associations
  platforms         CampaignPlatform[]

  // AI-generated content
  aiContent         AIContent[]

  // Media assets
  media             Media[]

  // Tonic campaign data
  tonicCampaignId       String?            @unique
  tonicArticleId        String?
  tonicArticleRequestId String?            // Article request ID for async polling
  tonicTrackingLink     String?
  tonicDirectLink       String?            // Preview URL for RSOC article

  // DesignFlow configuration (set in wizard, used when article is approved)
  needsDesignFlow       Boolean  @default(false) // True = wait for DesignFlow, False = launch directly
  designFlowRequester   String?            // Requester for DesignFlow task (Harry/Jesus/Milher)
  designFlowNotes       String?            // Additional notes for design team

  // Error details (when status is FAILED)
  errorDetails      Json?              // { step, message, timestamp, platform?, technicalDetails? }

  // Dashboard relations
  streak              CampaignStreak?
  stopLossViolations  StopLossViolation[]

  // DesignFlow integration
  designFlowTask      DesignFlowTask?

  // Metadata
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  launchedAt        DateTime?

  @@index([status])
  @@index([offerId])
  @@index([createdById])
}

model Offer {
  id          String     @id @default(cuid())
  tonicId     String     @unique
  name        String
  vertical    String
  description String?

  campaigns   Campaign[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tonicId])
}

model CampaignPlatform {
  id                 String   @id @default(cuid())
  campaignId         String
  campaign           Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  platform           Platform

  // Account references
  tonicAccountId     String?
  tonicAccount       Account? @relation("TonicAccount", fields: [tonicAccountId], references: [id])

  metaAccountId      String?
  metaAccount        Account? @relation("MetaAccount", fields: [metaAccountId], references: [id])

  tiktokAccountId    String?
  tiktokAccount      Account? @relation("TikTokAccount", fields: [tiktokAccountId], references: [id])

  taboolaAccountId   String?
  taboolaAccount     Account? @relation("TaboolaAccount", fields: [taboolaAccountId], references: [id])

  // Campaign Settings
  performanceGoal    String?
  pixelId            String?
  destinationPage    String?
  budget             Float?
  startDate          DateTime?
  uploadMultimedia   Boolean  @default(true)
  generateWithAI     Boolean  @default(true)
  aiMediaType        String?  // 'IMAGE' | 'VIDEO' | 'BOTH' - what type of media to generate with AI
  aiMediaCount       Int      @default(1) // How many images/videos to generate (1-5)
  adsPerAdSet        Int      @default(1) // For ABO: How many ads to put in each ad set (1-5)
  specialAdCategories String[] @default([])

  // Manual Ad Copy (for Meta)
  manualAdTitle      String?
  manualDescription  String?
  manualPrimaryText  String?

  // Manual Ad Copy (for TikTok)
  manualTiktokAdText String?  // Ad text/title for TikTok ads (optional, uses AI if empty)

  // User-selected Fan Page/Identity (for wizard selection)
  metaPageId         String?  // Facebook Fan Page ID selected by user in wizard
  instagramAccountId String?  // Instagram Account ID selected by user in wizard (optional)
  tiktokIdentityId   String?  // TikTok Identity ID selected by user in wizard
  tiktokIdentityType String?  // TikTok Identity type (CUSTOMIZED_USER, BC_OWNED, etc.)

  // Platform-specific IDs after launch
  metaCampaignId     String?
  metaAdSetId        String?
  metaAdId           String?

  tiktokCampaignId   String?
  tiktokAdGroupId    String?
  tiktokAdId         String?

  taboolaCampaignId  String?
  taboolaItemId      String?  // "Item" is the Ad in Taboola

  // Taboola-specific settings
  taboolaBidStrategy String?  // FIXED, MAX_CONVERSIONS, TARGET_CPA, ENHANCED_CPC
  taboolaCpc         Float?   // Cost per click (when bid_strategy is FIXED)
  taboolaBrandingText String? // Branding text for Taboola ads

  // Status
  status             CampaignStatus @default(DRAFT)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([campaignId, platform])
  @@index([campaignId])
  @@index([platform])
  @@index([tonicAccountId])
  @@index([metaAccountId])
  @@index([tiktokAccountId])
  @@index([taboolaAccountId])
}

model AIContent {
  id               String     @id @default(cuid())
  campaignId       String
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  contentType      String
  content          Json
  model            String
  prompt           String     @db.Text
  tokensUsed       Int?

  createdAt        DateTime   @default(now())

  @@index([campaignId])
  @@index([contentType])
}

model Media {
  id               String     @id @default(cuid())
  campaignId       String
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  type             MediaType

  generatedByAI    Boolean    @default(false)
  aiModel          String?
  aiPrompt         String?    @db.Text

  url              String
  gcsPath          String?
  fileName         String
  fileSize         Int?
  mimeType         String

  width            Int?
  height           Int?
  duration         Float?

  usedInMeta       Boolean    @default(false)
  usedInTiktok     Boolean    @default(false)
  metaHash         String?
  tiktokVideoId    String?

  // Video-Thumbnail relationship (for videos with associated thumbnails)
  thumbnailMediaId String?
  thumbnail        Media?     @relation("VideoThumbnail", fields: [thumbnailMediaId], references: [id])
  videosThumbnail  Media[]    @relation("VideoThumbnail")

  createdAt        DateTime   @default(now())

  @@index([campaignId])
  @@index([type])
  @@index([thumbnailMediaId])
}

// ============================================
// GLOBAL SETTINGS
// ============================================

model GlobalSettings {
  id                      String   @id @default(cuid())

  // AI APIs
  anthropicApiKey         String?  @db.Text

  // Google Cloud (Vertex AI)
  gcpProjectId            String?
  gcpServiceAccountKey    String?  @db.Text
  gcpStorageBucket        String?
  gcpLocation             String?  @default("us-central1")

  // Shared Meta credentials
  metaAppId               String?
  metaAppSecret           String?  @db.Text
  metaAccessToken         String?  @db.Text

  // Shared TikTok credentials
  tiktokAccessToken       String?  @db.Text

  // Email Notifications
  notificationEmails      String?  // Comma-separated emails: "manager1@email.com, manager2@email.com"

  updatedAt               DateTime @updatedAt

  @@map("global_settings")
}

// ============================================
// AUTHENTICATION
// ============================================

model Manager {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String
  name         String
  role         ManagerRole  @default(MANAGER)

  // Campaigns created by this manager
  campaigns    Campaign[]   @relation("CampaignCreator")

  // Dashboard metrics relations
  dailyMetrics        DailyMetrics[]
  campaignStreaks     CampaignStreak[]
  stopLossViolations  StopLossViolation[]
  weeklySnapshots     WeeklySnapshot[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  lastLoginAt  DateTime?

  @@index([email])
  @@index([role])
}

model InvitationCode {
  id        String    @id @default(cuid())
  code      String    @unique
  used      Boolean   @default(false)
  usedBy    String?   // Manager ID that used this code
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([code])
  @@index([used])
}

// ============================================
// AD RULES - Automated Rules for Meta & TikTok Ads
// ============================================

enum AdRulePlatform {
  META
  TIKTOK
}

enum AdRuleLevel {
  CAMPAIGN
  AD_SET      // Meta terminology
  AD_GROUP    // TikTok terminology (equivalent to AD_SET)
  AD
}

enum AdRuleMetric {
  ROAS           // Return on Ad Spend (primary)
  CPA            // Cost per Action
  CPM            // Cost per 1000 impressions
  CPC            // Cost per Click
  CTR            // Click-through Rate
  SPEND          // Total spend
  IMPRESSIONS    // Total impressions
  CLICKS         // Total clicks
  CONVERSIONS    // Total conversions
}

enum AdRuleOperator {
  GREATER_THAN
  LESS_THAN
  BETWEEN
  NOT_BETWEEN
}

enum AdRuleAction {
  NOTIFY
  PAUSE
  UNPAUSE
  INCREASE_BUDGET
  DECREASE_BUDGET
}

model AdRule {
  id              String         @id @default(cuid())
  name            String
  isActive        Boolean        @default(true)

  // Platform - META or TIKTOK
  platform        AdRulePlatform @default(META)

  // Scope - what level this rule applies to
  level           AdRuleLevel

  // Target - which entity IDs this applies to
  // If empty, applies to ALL active entities of that level
  targetIds       String[]       @default([])

  // Campaign Scope - apply to all campaigns or specific ones
  applyToAllCampaigns  Boolean   @default(false)  // false = specific campaigns, true = all campaigns
  specificCampaignIds  String[]  @default([])     // Campaign IDs if applyToAllCampaigns is false

  // Meta Account - for META platform rules (optional)
  metaAccountId   String?
  metaAccount     Account?       @relation("MetaRuleAccount", fields: [metaAccountId], references: [id])

  // TikTok Account - for TIKTOK platform rules (optional)
  tiktokAccountId String?
  tiktokAccount   Account?       @relation("TikTokRuleAccount", fields: [tiktokAccountId], references: [id])

  // Tonic Account - for ROAS calculation (Gross Revenue comes from Tonic)
  tonicAccountId  String?
  tonicAccount    Account?       @relation("TonicRuleAccount", fields: [tonicAccountId], references: [id])

  // ROAS Date Range - configurable date for Tonic stats
  roasDateRange   String?        // "today", "yesterday", "last7days", "last30days"

  // Condition
  metric          AdRuleMetric
  operator        AdRuleOperator
  value           Float          // Value for >, <
  valueMin        Float?         // Min value for BETWEEN/NOT_BETWEEN
  valueMax        Float?         // Max value for BETWEEN/NOT_BETWEEN

  // Frequency - how often the rule runs (in hours) after schedule start
  // e.g., frequencyHours=3 means rule runs every 3 hours starting from scheduleHours
  frequencyHours  Int            @default(1) // Run every X hours (1, 2, 3, 6, 12, 24)

  // DEPRECATED: timeWindow is no longer used, keeping for backward compatibility
  timeWindow      String         @default("TODAY") // @deprecated - use frequencyHours instead

  // Action
  action          AdRuleAction
  actionValue     Float?         // Percentage or fixed amount for budget changes
  actionValueType String?        // PERCENTAGE or FIXED
  notifyEmails    String[]       @default([]) // Emails for notification

  // Schedule - when the rule cycle STARTS
  // Example: scheduleDays=[2,4] (Tue, Thu), scheduleHours=[6] (6:00 UTC)
  // With frequencyHours=3, rule runs at 6:00, 9:00, 12:00, 15:00, 18:00, 21:00 on Tue/Thu
  scheduleHours   Int[]          @default([]) // Hours of day (0-23) when cycle starts, empty = all
  scheduleDays    Int[]          @default([]) // Days of week (0=Sun, 6=Sat), empty = all

  // Execution control
  lastCheckedAt   DateTime?
  lastTriggeredAt DateTime?
  executionCount  Int            @default(0)

  // Limits
  cooldownMinutes Int            @default(60) // Min time between executions
  maxExecutions   Int?           // Max executions (null = unlimited)

  // History
  executions      AdRuleExecution[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([platform])
  @@index([metaAccountId])
  @@index([tiktokAccountId])
  @@index([tonicAccountId])
  @@index([isActive])
  @@index([level])
}

model AdRuleExecution {
  id              String    @id @default(cuid())
  ruleId          String
  rule            AdRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Which entity triggered the rule
  targetType      String    // CAMPAIGN, AD_SET, AD
  targetId        String    // Meta ID of the entity
  targetName      String?   // Name for reference

  // Values at execution time
  metricValue     Float     // Metric value that triggered the rule
  conditionMet    Boolean   // Whether condition was met

  // Result
  actionTaken     String    // The action that was taken
  actionResult    String?   // Success, error, etc.
  actionDetails   Json?     // Additional details (e.g., previous/new budget)

  executedAt      DateTime  @default(now())

  @@index([ruleId])
  @@index([executedAt])
  @@index([targetId])
}

// ============================================
// DASHBOARD METRICS
// ============================================

// Daily cached metrics per manager (for performance dashboard)
model DailyMetrics {
  id                String    @id @default(cuid())
  date              DateTime  @db.Date
  managerId         String
  manager           Manager   @relation(fields: [managerId], references: [id])

  // Revenue & Spend aggregates
  grossRevenue      Float     @default(0)  // From Tonic (all campaigns)
  totalSpend        Float     @default(0)  // From Meta + TikTok
  netRevenue        Float     @default(0)  // grossRevenue - totalSpend
  roi               Float     @default(0)  // ((grossRevenue - totalSpend) / totalSpend) * 100

  // Campaign counts
  activeCampaigns   Int       @default(0)
  campaignsLaunched Int       @default(0)  // New campaigns that became ACTIVE that day

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([date, managerId])
  @@index([managerId])
  @@index([date])
}

// EverGreen streak tracking per campaign
model CampaignStreak {
  id              String    @id @default(cuid())
  campaignId      String    @unique
  campaign        Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  managerId       String
  manager         Manager   @relation(fields: [managerId], references: [id])

  // Current streak
  currentStreak   Int       @default(0)   // Days meeting criteria (ROI >40%, spend >$200)
  streakStartDate DateTime?               // When current streak started
  lastQualifyDate DateTime?               // Last date that met criteria

  // Historical data
  maxStreak       Int       @default(0)   // Highest streak achieved
  everGreenDate   DateTime?               // Date when 30-day streak was achieved
  isEverGreen     Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([managerId])
  @@index([isEverGreen])
  @@index([currentStreak])
}

// Stop-Loss violations log
model StopLossViolation {
  id              String        @id @default(cuid())
  campaignId      String
  campaign        Campaign      @relation(fields: [campaignId], references: [id])
  managerId       String
  manager         Manager       @relation(fields: [managerId], references: [id])

  violationType   StopLossType  // IMMEDIATE_LOSS or TIME_BASED_LOSS
  netRevenue      Float         // Net revenue at violation time
  hoursActive     Float?        // Hours since campaign became ACTIVE

  notifiedAt      DateTime      @default(now())  // When alert was sent
  acknowledgedAt  DateTime?                      // When manager acknowledged

  createdAt       DateTime      @default(now())

  @@index([managerId])
  @@index([campaignId])
  @@index([createdAt])
  @@index([acknowledgedAt])
  @@index([managerId, acknowledgedAt]) // Composite index for dashboard queries
}

// Weekly performance snapshot for historical tracking
model WeeklySnapshot {
  id              String    @id @default(cuid())
  managerId       String
  manager         Manager   @relation(fields: [managerId], references: [id])

  // Week identification
  weekNumber      Int       // ISO week number (1-53)
  year            Int
  weekStart       DateTime  // Monday of that week
  weekEnd         DateTime  // Friday of that week

  // Performance metrics
  campaignsLaunched Int     @default(0)  // Campaigns launched during the week
  weeklyGoal        Int     @default(15) // Target campaigns per week
  goalAchieved      Boolean @default(false)

  // Financial metrics
  grossRevenue    Float     @default(0)
  totalSpend      Float     @default(0)
  netRevenue      Float     @default(0)
  roi             Float     @default(0)

  // Additional stats
  activeCampaigns Int       @default(0)  // Active campaigns at week end
  stopLossCount   Int       @default(0)  // Stop-loss violations during week

  // Reset tracking
  resetBy         String?   // Manager ID who reset the week (SUPERADMIN)
  resetAt         DateTime?

  createdAt       DateTime  @default(now())

  @@unique([managerId, weekNumber, year])
  @@index([managerId])
  @@index([year, weekNumber])
  @@index([weekStart])
}

// ============================================
// DESIGNFLOW INTEGRATION
// ============================================

// Tracks tasks sent to DesignFlow for design work
model DesignFlowTask {
  id                String    @id @default(cuid())

  // Link to LaunchPro campaign
  campaignId        String    @unique
  campaign          Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // DesignFlow task reference
  designflowTaskId  String    @unique  // ID in DesignFlow's tasks table
  status            String    // To Do, In Progress, Review, Done
  title             String
  requester         String    // Harry, Jesus, Milher

  // Timestamps
  sentAt            DateTime  @default(now())
  completedAt       DateTime?

  // Delivery info (populated when design is complete)
  deliveryLink      String?   // Link to final design assets

  @@index([campaignId])
  @@index([designflowTaskId])
  @@index([status])
}
