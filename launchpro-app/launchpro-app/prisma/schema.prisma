// Prisma Schema for LaunchPro - Digital Ads Campaign Management (Multi-Account Support)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Platform {
  TONIC
  META
  TIKTOK
}

enum CampaignStatus {
  DRAFT              // Initial creation, not yet launched
  PENDING_ARTICLE    // Waiting for Tonic article approval (async)
  ARTICLE_APPROVED   // Article approved, ready to continue processing
  GENERATING_AI      // AI is generating content
  READY_TO_LAUNCH    // AI content ready, waiting for launch
  LAUNCHING          // In process of launching to platforms
  ACTIVE             // Successfully launched and active
  PAUSED             // Paused by user
  COMPLETED          // Campaign finished
  FAILED             // Failed during launch
}

enum MediaType {
  IMAGE
  VIDEO
}

enum CampaignType {
  CBO  // Campaign Budget Optimization
  ABO  // Ad Set Budget Optimization
}

enum AccountType {
  TONIC
  META
  TIKTOK
}

// ============================================
// ACCOUNT MANAGEMENT
// ============================================

model Account {
  id          String      @id @default(cuid())
  name        String      // e.g., "TikTok TG-JM", "Meta B1 - Capital Quick"
  accountType AccountType

  // Tonic accounts
  tonicConsumerKey    String? // For Tonic accounts
  tonicConsumerSecret String? // For Tonic accounts
  tonicJwtToken       String? @db.Text // Cached JWT token
  tonicTokenExpiry    DateTime? // Token expiration

  // Tonic capabilities cache (to avoid repeated API calls)
  tonicSupportsRSOC   Boolean? // Does this account support RSOC campaigns?
  tonicSupportsDisplay Boolean? // Does this account support Display campaigns?
  tonicRSOCDomains    Json? // Available RSOC domains with languages
  tonicCapabilitiesLastChecked DateTime? // When were capabilities last checked

  // Meta accounts
  metaAdAccountId String? // e.g., "act_641975565566309"
  metaPortfolio   String? // e.g., "Capital Quick LLC"
  metaPageId      String? // e.g., "1039541308325786"
  metaAccessToken String? @db.Text // Account-specific access token
  metaPixelId     String? // Account-specific pixel ID

  // TikTok accounts
  tiktokAdvertiserId String? // e.g., "7476563770333167633"
  tiktokAccessToken  String? @db.Text // Account-specific access token
  tiktokPixelId      String? // Account-specific pixel ID

  // Linked Tonic Account (for Meta/TikTok accounts)
  linkedTonicAccountId String?
  linkedTonicAccount   Account?  @relation("LinkedTonicAccount", fields: [linkedTonicAccountId], references: [id])
  linkedAccounts       Account[] @relation("LinkedTonicAccount")

  // Relationships
  campaignsAsTonic CampaignPlatform[] @relation("TonicAccount")
  campaignsAsMeta  CampaignPlatform[] @relation("MetaAccount")
  campaignsAsTikTok CampaignPlatform[] @relation("TikTokAccount")

  // Ad Rules
  adRules          AdRule[]

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountType, name])
  @@index([accountType])
  @@index([isActive])
  @@index([linkedTonicAccountId])
}

// ============================================
// MAIN MODELS
// ============================================

model Campaign {
  id                String             @id @default(cuid())
  name              String
  status            CampaignStatus     @default(DRAFT)
  campaignType      CampaignType

  // Tonic Configuration
  offerId           String
  offer             Offer              @relation(fields: [offerId], references: [id])
  country           String
  language          String

  // AI Content
  copyMaster        String?
  communicationAngle String?
  keywords          String[]           @default([])

  // Platform associations
  platforms         CampaignPlatform[]

  // AI-generated content
  aiContent         AIContent[]

  // Media assets
  media             Media[]

  // Tonic campaign data
  tonicCampaignId       String?            @unique
  tonicArticleId        String?
  tonicArticleRequestId String?            // Article request ID for async polling
  tonicTrackingLink     String?

  // Error details (when status is FAILED)
  errorDetails      Json?              // { step, message, timestamp, platform?, technicalDetails? }

  // Metadata
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  launchedAt        DateTime?

  @@index([status])
  @@index([offerId])
}

model Offer {
  id          String     @id @default(cuid())
  tonicId     String     @unique
  name        String
  vertical    String
  description String?

  campaigns   Campaign[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tonicId])
}

model CampaignPlatform {
  id                 String   @id @default(cuid())
  campaignId         String
  campaign           Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  platform           Platform

  // Account references
  tonicAccountId     String?
  tonicAccount       Account? @relation("TonicAccount", fields: [tonicAccountId], references: [id])

  metaAccountId      String?
  metaAccount        Account? @relation("MetaAccount", fields: [metaAccountId], references: [id])

  tiktokAccountId    String?
  tiktokAccount      Account? @relation("TikTokAccount", fields: [tiktokAccountId], references: [id])

  // Campaign Settings
  performanceGoal    String?
  pixelId            String?
  destinationPage    String?
  budget             Float?
  startDate          DateTime?
  uploadMultimedia   Boolean  @default(true)
  generateWithAI     Boolean  @default(true)
  aiMediaType        String?  // 'IMAGE' | 'VIDEO' | 'BOTH' - what type of media to generate with AI
  aiMediaCount       Int      @default(1) // How many images/videos to generate (1-5)
  specialAdCategories String[] @default([])

  // Manual Ad Copy (for Meta)
  manualAdTitle      String?
  manualDescription  String?
  manualPrimaryText  String?

  // Manual Ad Copy (for TikTok)
  manualTiktokAdText String?  // Ad text/title for TikTok ads (optional, uses AI if empty)

  // User-selected Fan Page/Identity (for wizard selection)
  metaPageId         String?  // Facebook Fan Page ID selected by user in wizard
  tiktokIdentityId   String?  // TikTok Identity ID selected by user in wizard
  tiktokIdentityType String?  // TikTok Identity type (CUSTOMIZED_USER, BC_OWNED, etc.)

  // Platform-specific IDs after launch
  metaCampaignId     String?
  metaAdSetId        String?
  metaAdId           String?

  tiktokCampaignId   String?
  tiktokAdGroupId    String?
  tiktokAdId         String?

  // Status
  status             CampaignStatus @default(DRAFT)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([campaignId, platform])
  @@index([campaignId])
  @@index([platform])
  @@index([tonicAccountId])
  @@index([metaAccountId])
  @@index([tiktokAccountId])
}

model AIContent {
  id               String     @id @default(cuid())
  campaignId       String
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  contentType      String
  content          Json
  model            String
  prompt           String     @db.Text
  tokensUsed       Int?

  createdAt        DateTime   @default(now())

  @@index([campaignId])
  @@index([contentType])
}

model Media {
  id               String     @id @default(cuid())
  campaignId       String
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  type             MediaType

  generatedByAI    Boolean    @default(false)
  aiModel          String?
  aiPrompt         String?    @db.Text

  url              String
  gcsPath          String?
  fileName         String
  fileSize         Int?
  mimeType         String

  width            Int?
  height           Int?
  duration         Float?

  usedInMeta       Boolean    @default(false)
  usedInTiktok     Boolean    @default(false)
  metaHash         String?
  tiktokVideoId    String?

  // Video-Thumbnail relationship (for videos with associated thumbnails)
  thumbnailMediaId String?
  thumbnail        Media?     @relation("VideoThumbnail", fields: [thumbnailMediaId], references: [id])
  videosThumbnail  Media[]    @relation("VideoThumbnail")

  createdAt        DateTime   @default(now())

  @@index([campaignId])
  @@index([type])
  @@index([thumbnailMediaId])
}

// ============================================
// GLOBAL SETTINGS
// ============================================

model GlobalSettings {
  id                      String   @id @default(cuid())

  // AI APIs
  anthropicApiKey         String?  @db.Text

  // Google Cloud (Vertex AI)
  gcpProjectId            String?
  gcpServiceAccountKey    String?  @db.Text
  gcpStorageBucket        String?
  gcpLocation             String?  @default("us-central1")

  // Shared Meta credentials
  metaAppId               String?
  metaAppSecret           String?  @db.Text
  metaAccessToken         String?  @db.Text

  // Shared TikTok credentials
  tiktokAccessToken       String?  @db.Text

  // Email Notifications
  notificationEmails      String?  // Comma-separated emails: "manager1@email.com, manager2@email.com"

  updatedAt               DateTime @updatedAt

  @@map("global_settings")
}

// ============================================
// AUTHENTICATION
// ============================================

model Manager {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  @@index([email])
}

model InvitationCode {
  id        String    @id @default(cuid())
  code      String    @unique
  used      Boolean   @default(false)
  usedBy    String?   // Manager ID that used this code
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([code])
  @@index([used])
}

// ============================================
// AD RULES - Automated Rules for Meta Ads
// ============================================

enum AdRuleLevel {
  CAMPAIGN
  AD_SET
  AD
}

enum AdRuleMetric {
  ROAS           // Return on Ad Spend (primary)
  CPA            // Cost per Action
  CPM            // Cost per 1000 impressions
  CPC            // Cost per Click
  CTR            // Click-through Rate
  SPEND          // Total spend
  IMPRESSIONS    // Total impressions
  CLICKS         // Total clicks
  CONVERSIONS    // Total conversions
}

enum AdRuleOperator {
  GREATER_THAN
  LESS_THAN
  BETWEEN
  NOT_BETWEEN
}

enum AdRuleAction {
  NOTIFY
  PAUSE
  UNPAUSE
  INCREASE_BUDGET
  DECREASE_BUDGET
}

model AdRule {
  id              String         @id @default(cuid())
  name            String
  isActive        Boolean        @default(true)

  // Scope - what level this rule applies to
  level           AdRuleLevel

  // Target - which Meta entity IDs this applies to
  // If empty, applies to ALL active entities of that level
  targetIds       String[]       @default([])

  // Account - which Meta account this rule belongs to
  metaAccountId   String
  metaAccount     Account        @relation(fields: [metaAccountId], references: [id])

  // Condition
  metric          AdRuleMetric
  operator        AdRuleOperator
  value           Float          // Value for >, <
  valueMin        Float?         // Min value for BETWEEN/NOT_BETWEEN
  valueMax        Float?         // Max value for BETWEEN/NOT_BETWEEN
  timeWindow      String         @default("TODAY") // TODAY, LAST_7D, LAST_14D, LAST_30D

  // Action
  action          AdRuleAction
  actionValue     Float?         // Percentage or fixed amount for budget changes
  actionValueType String?        // PERCENTAGE or FIXED
  notifyEmails    String[]       @default([]) // Emails for notification

  // Schedule
  scheduleHours   Int[]          @default([]) // Hours of day (0-23), empty = all
  scheduleDays    Int[]          @default([]) // Days of week (0=Sun, 6=Sat), empty = all

  // Execution control
  lastCheckedAt   DateTime?
  lastTriggeredAt DateTime?
  executionCount  Int            @default(0)

  // Limits
  cooldownMinutes Int            @default(60) // Min time between executions
  maxExecutions   Int?           // Max executions (null = unlimited)

  // History
  executions      AdRuleExecution[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([metaAccountId])
  @@index([isActive])
  @@index([level])
}

model AdRuleExecution {
  id              String    @id @default(cuid())
  ruleId          String
  rule            AdRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Which entity triggered the rule
  targetType      String    // CAMPAIGN, AD_SET, AD
  targetId        String    // Meta ID of the entity
  targetName      String?   // Name for reference

  // Values at execution time
  metricValue     Float     // Metric value that triggered the rule
  conditionMet    Boolean   // Whether condition was met

  // Result
  actionTaken     String    // The action that was taken
  actionResult    String?   // Success, error, etc.
  actionDetails   Json?     // Additional details (e.g., previous/new budget)

  executedAt      DateTime  @default(now())

  @@index([ruleId])
  @@index([executedAt])
  @@index([targetId])
}
