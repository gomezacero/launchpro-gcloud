// Prisma Schema for LaunchPro - Digital Ads Campaign Management
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Platform {
  TONIC
  META
  TIKTOK
}

enum CampaignStatus {
  DRAFT           // Initial creation, not yet launched
  GENERATING_AI   // AI is generating content
  READY_TO_LAUNCH // AI content ready, waiting for launch
  LAUNCHING       // In process of launching to platforms
  ACTIVE          // Successfully launched and active
  PAUSED          // Paused by user
  COMPLETED       // Campaign finished
  FAILED          // Failed during launch
}

enum MediaType {
  IMAGE
  VIDEO
}

enum CampaignType {
  CBO  // Campaign Budget Optimization
  ABO  // Ad Set Budget Optimization
}

// ============================================
// MAIN MODELS
// ============================================

model Campaign {
  id                String             @id @default(cuid())
  name              String
  status            CampaignStatus     @default(DRAFT)
  campaignType      CampaignType       // CBO or ABO (from the sheet)

  // Tonic Configuration (Step 1 - Partner Settings from sheet)
  offerId           String
  offer             Offer              @relation(fields: [offerId], references: [id])
  country           String             // Country code (e.g., "US")
  language          String             // Language code (e.g., "en")

  // Copy Master - AI generated based on offer
  copyMaster        String?            // AI-generated communication aligned with offer

  // Communication angle (list - to be explained by user)
  communicationAngle String?           // To be filled based on user's explanation

  // Keywords - AI generated or manual
  keywords          String[]           @default([])

  // Platform associations
  platforms         CampaignPlatform[]

  // AI-generated content
  aiContent         AIContent[]

  // Media assets (images/videos)
  media             Media[]

  // Tonic campaign data
  tonicCampaignId   String?            @unique
  tonicArticleId    String?            // headline_id for RSOC
  tonicTrackingLink String?

  // Metadata
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  launchedAt        DateTime?

  @@index([status])
  @@index([offerId])
}

model Offer {
  id          String     @id @default(cuid())
  tonicId     String     @unique  // Offer ID from Tonic API
  name        String
  vertical    String     // e.g., "Car Loans", "Communication"
  description String?

  campaigns   Campaign[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tonicId])
}

model CampaignPlatform {
  id                 String   @id @default(cuid())
  campaignId         String
  campaign           Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  platform           Platform

  // Step 2 - Campaign Settings from sheet
  performanceGoal    String?  // e.g., "Fan page", "App installs"
  pixelId            String?
  destinationPage    String?  // Instagram Page, TikTok Page, etc.
  budget             Float?
  startDate          DateTime?
  uploadMultimedia   Boolean  @default(true)

  // Generated by AI checkbox from sheet
  generateWithAI     Boolean  @default(true)

  // Platform-specific IDs after launch
  metaCampaignId     String?
  metaAdSetId        String?
  metaAdId           String?

  tiktokCampaignId   String?
  tiktokAdGroupId    String?
  tiktokAdId         String?

  // Status
  status             CampaignStatus @default(DRAFT)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([campaignId, platform])
  @@index([campaignId])
  @@index([platform])
}

model AIContent {
  id               String     @id @default(cuid())
  campaignId       String
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Content type
  contentType      String     // "keywords", "article", "ad_copy", "targeting"

  // Generated content
  content          Json       // Flexible JSON structure for different content types

  // AI metadata
  model            String     // e.g., "claude-3.5-sonnet", "gpt-4"
  prompt           String     @db.Text
  tokensUsed       Int?

  createdAt        DateTime   @default(now())

  @@index([campaignId])
  @@index([contentType])
}

model Media {
  id               String     @id @default(cuid())
  campaignId       String
  campaign         Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  type             MediaType

  // AI Generation metadata
  generatedByAI    Boolean    @default(false)
  aiModel          String?    // e.g., "imagen-4.0-fast-generate-001", "veo-3.1-fast"
  aiPrompt         String?    @db.Text

  // File storage
  url              String     // GCS URL or CDN URL
  gcsPath          String?    // Google Cloud Storage path
  fileName         String
  fileSize         Int?       // in bytes
  mimeType         String

  // Media properties
  width            Int?
  height           Int?
  duration         Float?     // For videos, in seconds

  // Usage tracking
  usedInMeta       Boolean    @default(false)
  usedInTiktok     Boolean    @default(false)
  metaHash         String?    // Meta's image hash after upload
  tiktokVideoId    String?    // TikTok's video ID after upload

  createdAt        DateTime   @default(now())

  @@index([campaignId])
  @@index([type])
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model PlatformCredentials {
  id                      String   @id @default(cuid())

  // Tonic
  tonicUsername           String?
  tonicPassword           String?
  tonicJwtToken           String?  @db.Text
  tonicTokenExpiry        DateTime?

  // Meta
  metaAccessToken         String?  @db.Text
  metaAdAccountId         String?
  metaPixelId             String?
  metaAppId               String?
  metaAppSecret           String?

  // TikTok
  tiktokAccessToken       String?  @db.Text
  tiktokAdvertiserId      String?
  tiktokAppId             String?
  tiktokAppSecret         String?
  tiktokPixelId           String?

  // AI APIs
  anthropicApiKey         String?  @db.Text

  // Google Cloud (Vertex AI)
  gcpProjectId            String?
  gcpServiceAccountKey    String?  @db.Text
  gcpStorageBucket        String?

  updatedAt               DateTime @updatedAt

  @@map("platform_credentials")
}
